"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(i,o){try{var u=r[i](o),a=u.value}catch(e){return void t(e)}if(!u.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}return n("next")})}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.logger=void 0;var index=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,i,o,u,a,s,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(process.env.NODE_MOUNTED_ROUTER||"").replace(/^\s*|\s*$/g,"")||"bundle",i=n.split(/\s+/),o=i.indexOf("bundle"),!((u=i.indexOf("debug"))>=0)){e.next=19;break}if(a=_config2.default.HTML_PAGE_PATH,s=_path3.default.join(a,"index.html"),!_fs2.default.existsSync(s)){e.next=14;break}return e.next=10,(0,_service.replaceIndexPage)();case 10:c=e.sent,r.body=c,e.next=17;break;case 14:return e.next=16,t();case 16:r.throw("404","Not Found for "+s+" file");case 17:e.next=20;break;case 19:o>=0?r.redirect(_apiDef2.default.qrCode):(r.type="text/plain",r.body="NO mounted Router!");case 20:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),bundle=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!_env.webAppEnv.debugOnly){e.next=3;break}return _utils.colorconsole.info("### App Server ### In debugOnly mode, skip download bundle"),e.abrupt("return");case 3:return n=_config2.default.bundlePath,i=(0,_service.getCPProjName)(),o=_path3.default.join(n,i+".rpk"),_fs2.default.existsSync(o)||(o=_path3.default.join(n,i+".signed.rpk")),_fs2.default.existsSync(o)?(r.body=_fs2.default.createReadStream(o),r.set("Content-Type","text/plain")):(_utils.colorconsole.error("### App Server ### 未能找到"+o+"文件, 请检查是否正确运行了npm run build"),r.throw("404","Not Found for "+o+" file!")),e.next=10,t();case 10:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),logger=exports.logger=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=(0,_utils.getClientIPAddress)(r.req),i=_url2.default.parse(r.req.url),o=i.path,"/"===o&&_utils.colorconsole.info("### App Server ### Logging incoming client request from: "+n),(0,_service.recordIncomingReqToFile)(n),e.next=7,t();case 7:e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### Logging exception: "+JSON.stringify(e.t0));case 12:case"end":return e.stop()}},e,this,[[0,9]])}));return function(r,t){return e.apply(this,arguments)}}(),qrCode=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n="http://"+SERVER_IP_ADDR,i=_qrImage2.default.image(n,{size:9}),e.next=4,t();case 4:r.type="image/png",r.body=i;case 6:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path2=require("path"),_path3=_interopRequireDefault(_path2),_url=require("url"),_url2=_interopRequireDefault(_url),_qrImage=require("qr-image"),_qrImage2=_interopRequireDefault(_qrImage),_utils=require("../../../lib/utils"),_env=require("../../env"),_apiDef=require("../apiDef"),_apiDef2=_interopRequireDefault(_apiDef),_config=require("../../../config"),_config2=_interopRequireDefault(_config),_service=require("../service"),PORT=_env.webAppEnv.PORT,SERVER_IP_ADDR=(0,_utils.getIPv4IPAddress)()+(80===PORT?"":":"+PORT);exports.default={index:index,bundle:bundle,qrCode:qrCode,logger:logger};