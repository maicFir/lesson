"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(o,i){try{var s=r[o](i),a=s.value}catch(e){return void t(e)}if(!s.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}return n("next")})}}function getInspectorUrl(e){var r=e.ws;return"http://"+SERVER_IP_ADDR+"/inspector/inspector.html?ws="+encodeURI(r)+"&remoteFrontend=true&dockSide=undocked"}function untarInspectorTarFile(){var e=_config2.default.inspectorHtmlDir,r=_config2.default.inspectorTarBallFile;return new Promise(function(t,n){if(_fs2.default.existsSync(e))t({code:0,message:"Not untaring"});else try{var o=r;if(!_fs2.default.existsSync(o)){var i=new Error("No inspector.tar.gz on deployed path");throw n(i),i}return _tar2.default.x({file:o,cwd:_path2.default.dirname(o)}),t({code:0,message:"untaring done"})}catch(i){throw i}}).catch(function(e){_utils.colorconsole.error("### App Server ### 解压inspector.tar.gz出错\n"+JSON.stringify(e))})}function printInspectorUrl(e){var r=e.request.body,t=r.ws,n=r.application,o=r.status,i=e.request.body["protocol-version"];emitWSEvent(e.io,"appRegistered",{ws:t,application:n,protocolVer:i,status:o}),_utils.colorconsole.info("### App Server ### 请访问以下链接进行调试：\n\n"+getInspectorUrl({ws:t})+"\n")}function informToUpdateApk(e){_utils.colorconsole.warn("### App Server ### 应用加载器有重要更新，请到http://dev.hybrid.xiaomi.com/更新您的应用加载器"),e.io.sockets.emit("informUpdate",{})}function emitWSEvent(e,r,t){e.sockets.emit(r,t||{})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.prepareStartServer=void 0;var prepareStartServer=exports.prepareStartServer=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,untarInspectorTarFile();case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 解压inspector.tar.gz文件出错\n "+JSON.stringify(e.t0));case 8:case"end":return e.stop()}},e,this,[[0,5]])}));return function(){return e.apply(this,arguments)}}();exports.getInspectorUrl=getInspectorUrl,exports.untarInspectorTarFile=untarInspectorTarFile,exports.printInspectorUrl=printInspectorUrl,exports.informToUpdateApk=informToUpdateApk,exports.emitWSEvent=emitWSEvent;var _path=require("path"),_path2=_interopRequireDefault(_path),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_tar=require("tar"),_tar2=_interopRequireDefault(_tar),_utils=require("../../../lib/utils"),_env=require("../../env"),_config=require("../../../config"),_config2=_interopRequireDefault(_config),PORT=_env.webAppEnv.PORT,SERVER_IP_ADDR=(0,_utils.getIPv4IPAddress)()+(80===PORT?"":":"+PORT);